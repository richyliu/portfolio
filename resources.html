<!DOCTYPE html>
<html>

<head>

    <script class="singulr-ignore" src="js/singulr-page.js"></script>

    <title>Resource - Troop 485</title>
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container hidden" id="loading">
        <div class="row">
            <div class="box col-md-12">

                <div>
                    <hr>
                    <h2 class="intro-text text-center">Loading. Please wait</h2>
                    <hr>
                    <p>Your event page is being created. A message is being posted on <a href="https://t485.slack.com/messages/general/" target="_blank">#general</a> on slack. Please wait. This usually takes around 15 seconds or less.</p>
                </div>
            </div>
        </div>
    </div>
    <div class="container" id="main">

        <div class="row">
            <div class="box col-md-6">

                <div id="event-list-box">
                    <hr>

                    <h2 class="intro-text text-center">Event Pages</h2>

                    <hr>



                    <ul id="event-list"></ul>





                    </ul>
                </div>
            </div>
            <div class="box col-md-6">
                <div id="resource-list">
                    <hr>
                    <h2 class="intro-text text-center">Resources</h2>
                    <hr>
                    <button class="btn btn-default" onclick="Singulr.loadPage('logout.html?redir=meeting-minutes.html')">Log out</button>
                    <ul>
                        <li><a onclick="openModal(this, 'https://docs.google.com/document/d/1IC1fttf7tEZhezKfNKs0ADtHOQjgyBcMSqjQ_75zUKk/mobilebasic');">Council Resource</a></li>
                        <li><a onclick="openModal(this, 'https://docs.google.com/document/d/1dtMPUhKv6eOfKaxk3iMwnRbovgu0yZt6J0mH8wPdBfY/mobilebasic');">Things to Remember</a></li>
                        <li><a onclick="openModal(this, 'https://docs.google.com/document/d/1ssoNp8eQqNzkeJAefQdLk6aqu5bEMGarUHX9RvpV1BU/mobilebasic');">Resume Template</a></li>
                        <li><a onclick="openModal(this, 'https://docs.google.com/document/d/1a56ZOlhhT1MT7QGXwLSzmsD5l1cahH44O6kUFNTAJ3I/mobilebasic');">Packing List</a></li>
                        <li><a onclick="openModal(this, 'https://docs.google.com/document/d/16ft2MS85ZYynyJC9lMIo6Kp8yaJQfcGmY62ayj97_uo/mobilebasic');">TLT2016 - Lecture Notes</a></li>
                        <li><a onclick="openModal(this, 'https://firebasestorage.googleapis.com/v0/b/project-2556333409340273878.appspot.com/o/resources%2FNew%20Boy%20Scout%20Requirements%202016%20Insert.pdf?alt=media&amp;token=3782b26b-c79c-49f3-bc35-a32f0ce0a7a9');">New Boy Scout Requirements 2016 Insert.pdf (343.8 KB)</a></li>
                        <li><a onclick="openModal(this, 'https://firebasestorage.googleapis.com/v0/b/project-2556333409340273878.appspot.com/o/resources%2FPatrol%20Leader%20Handbook.pdf?alt=media&amp;token=2c696c57-719e-4c23-9e70-d1154bd3f55e');">Patrol Leader Handbook.pdf (3.2 MB)</a></li>
                        <li><a onclick="openModal(this, 'https://firebasestorage.googleapis.com/v0/b/project-2556333409340273878.appspot.com/o/resources%2FBSA%20Fieldbook.pdf?alt=media&amp;token=06cf3993-def1-4e2d-b461-373ce77712a2');">BSA Fieldbook.pdf (69.8 MB)</a></li>
                        <li><a onclick="openModal(this, 'https://docs.google.com/presentation/embed?id=1cqU9DQ0c4RXcm0GJ-gJJ8pRP8Ah3WsYApBlaLbrnRhw&amp;start=false&amp;loop=false');">Year End Party Presentation</a></li>
                        <li><a onclick="openModal(this, 'https://docs.google.com/presentation/embed?id=16vDoqikgorGn4utl1sHBkMhXqbEbvwtGkJ5xMMfbm-o&amp;start=false&amp;loop=false');">2016 Advancement Update</a></li>
                        <li><a onclick="openModal(this, 'https://docs.google.com/presentation/embed?id=15e_mFNG0x4JIhqbCOZ3CDkVm_nrmEnXYE1RFOEQKd-w&amp;start=false&amp;loop=false');">Advancement Presentation</a></li>
                        <li><a onclick="openModal(this, 'https://docs.google.com/spreadsheets/d/1fjrkSV_svlleL1ltqJGgozIvEafzmmiMPCe7xEqnngI/pubhtml?widget=true&headers=false');">2016 Events</a></li>
                        <li><a onclick="openModal(this, 'https://drive.google.com/embeddedfolderview?id=0BygadbpNuUSXUXhRMUlycW0yNGs#' + (window.innerWidth > 767 ? 'grid' : 'list'));">Event Cheatsheets</a></li>
                    </ul>
                </div>
            </div>


        </div>
        <a name="event"></a>
        <div class="row">
            <div class="box col-md-12">
                <hr>
                <h2 class="intro-text text-center">Create New Event Page</h2>
                <hr>
                <b>When choosing a name, try to add the current year to the name so people can differentiate between the same event on different years.</b>
                <br>
                <label>Choose An Event Name(You can change this later):</label>


                <input type="text" id="name" class="form-control">


                <p id="error" class="text-danger"></p>
                <button class="btn btn-primary form-control" id="create-event-page">Create event page!</button>
            </div>
        </div>

        <!--
        <div class="row">
            <div class="box col-md-12">
                <hr>
                <h2 class="intro-text text-center">Add <strong>Files</strong></h2>
                <hr>
                <p>
                    You can upload your own resources. Be sure to provide a
                    meaningful event name or title. Please note that the title
                    of the file you upload is the name people see. If you want
                    to delete a file, email the webmaster with your event
                    name/title.
                </p>
                <form>
                    <div class="form-group">
                        <label for="event-name">Event name/title:</label>
                        <input type="text" class="form-control" id="event-name" required>
                    </div>
                    <div class="form-group">
                        <label for="files">File upload (you can select multiple)</label>
                        <input type="file" id="files" name="files[]" multiple class="form-control-file" required>
                    </div>
                    <div id="upload-progress"></div>
                    <div class="form-group">
                        <label for="drive-urls">Google Docs or Google Slides url and file name (one per line)</label>
                        <textarea class="form-control" id="drive-urls" rows="5" placeholder="https://docs.google.com/document/d/1W98GkzMbu3MhVX4bq981dyjifWLYr3Bat6ej-iE52Os/mobilebasic,This is a test file"></textarea>
                    </div>
                    <div class="form-group">
                        <input type="submit" id="submit" value="Submit" class="btn btn-default">
                    </div>
                </form>
            </div>
        </div>
        -->

        <script src="https://static.getclicky.com/js"></script>
        <script>try{clicky.init(100869133)}catch(e){}</script>

        <noscript><p><img alt="Clicky" width="1" height="1" src="https://in.getclicky.com/100869133ns.gif"></p></noscript>
    </div>
    <!-- /.container -->


    <!-- Modal -->
    <div aria-hidden="true" aria-labelledby="myModalLabel" class="modal fade" id="myModal" role="dialog" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">code.jeffkmeng.com
                    <button aria-hidden="true" class="close" data-dismiss="modal" type="button">&times;</button>
                    <h4 class="modal-title" id="myModalLabel">Content Unavaliable</h4>
                </div>

                <div class="modal-body">
                    <iframe frameborder="0" height="90%" id="ifr" name="ifr" src="" width="90%">Unfortunately, this content is unavaliable at this time. Please give feedback for this bug, and view the document on your google drive.</iframe>
                </div>

                <div class="modal-footer">
                    <a class="btn btn-primary" href="https://google.com" id="mdlk" target="_blank" type="button">Open in new tab</a>
                    <button class="btn btn-primary" onclick="requestFullScreen();">Fullscreen mode</button>
                    <button class="btn btn-default" data-dismiss="modal" type="button">Close</button>
                </div>
            </div>
            <!-- /.modal-content -->
        </div>
        <!-- /.modal-dialog -->
    </div>


    <script>
        /* global firebase $ auth Singulr */

        String.prototype.replaceAll = function(search, replacement) {
            var target = this;
            return target.split(search).join(replacement);
        };
        auth(function(user) {
            $("#create-event-page").click(function() {

                $("#error").html("");
                var title = $("#name").val();


                var push = firebase.database().ref("/events/").push({
                    title: title,
                    owner: user.uid,
                    description: "This event has not been edited yet.<br> <b>Owner</b>: Click the above edit button and then click on this paragraph or the page title to edit that element. After editing a paragraph, <b>click save changes in the toolbar that pops up to save your changes</b>."
                });
                var url = push.key;
                $("#main").addClass("hidden");
                $("#loading").removeClass("hidden");

                $.post("https://hooks.slack.com/services/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", "payload=" + JSON.stringify({
                        "text": "New Event Page Created:",
                        "attachments": [{
                            "fallback": "A new event page was created: <" + title + "|https://t485.org/event.html?event=" + url + ">.",
                            "title": title,
                            "title_link": "https://t485.org/event.html?event=" + url,
                            "text": "Go to <https://t485.org/event.html?event=" + url + "> to view the content(May not have been updated by author yet.)",
                            "footer": "This is a T485 event page automated message"
                        }]
                    }),
                    function(data) {
                        window.location.href = "event.html?event=" + url;
                    }
                );




            });
        }, function() {
            Singulr.loadPage('login.html?redir=resources.html');
        });
        firebase.database().ref("/events/").on("child_added", function(data) {

            var name = data.val().title;
            $("#event-list").prepend("<li><a class='name' href='event.html?event=" + data.key + "'>" + name + "</a></li>");

        });





        /*
        var storageRef = firebase.storage().ref();
        var ref = firebase.database().ref();
        
        
        
        ref.child('resourceUrls').on('child_added', function(snapshot) {
            var response = snapshot.val();
            var listElement = document.getElementById('resource-list');
            var eventName = response.event;
            var resourceUrls = response.urls.split(',');
            var resourceNames = response.names.split(',');
            var resourceSizes = response.sizes.split(',');
            
            var div = document.createElement('div');
            var h4 = document.createElement('h4');
            h4.innerHTML = eventName;
            div.appendChild(h4);
            
            var list = document.createElement('ul');
            
            for (var i = 0; i < resourceUrls.length; i++) {
                var listItem = document.createElement('li');
                var a = document.createElement('a');
                a.href = resourceUrls[i];
                console.log(resourceSizes[i]);
                a.innerHTML = resourceNames[i] + (resourceSizes[i] === '?' ? '' : (' (' + resourceSizes[i] + ')'));
                a.addEventListener('click', (function(i) {
                    return function(e) {
                        e.preventDefault();
                        e.stopImmediatePropagation();
                        
                        openModal(undefined, resourceUrls[i], resourceNames[i]);
                    };
                })(i));
                    
                
                listItem.appendChild(a);
                list.appendChild(listItem);
            }
            
            div.appendChild(list);
            
            listElement.appendChild(div);
        });
        
        
        
        
        document.getElementById('submit').onclick = function(e) {
            e.preventDefault();
            
            var files = document.getElementById('files').files;
            if (document.getElementById('event-name').value === '') {
                alert('Please provide a meaningful event name/title!');
                return;
            }
            
            var loadedFiles = new Array(files.length);
            var downloadURLs = [];
            var downloadNames = [];
            var downloadSizes = [];
            
            
            if (files.length < 1) {
                doAfter();
                return;
            }
            
            for (var i = 0; i < files.length; i++) {
                uploadFile(files[i], i, function(downloadURL, i) {
                    loadedFiles[i] = true;
                    
                    downloadURLs.push(downloadURL);
                    downloadNames.push(files[i].name);
                    // larger than 100 mb
                    if (files[i].size > 100000000) {
                        alert('File too large!');
                        throw new Error('The file is too large (bigger than 100mb)');
                    }
                    // 1 decimal place
                    downloadSizes.push(formatBytes(files[i].size, 0));
                    console.log(downloadURL);
                    
                    for (var j = 0; j < files.length; j++) {
                        if (loadedFiles[j] === undefined) return;
                    }
                    
                    
                    // all files are loaded
                    doAfter();
                });
            }
            
            function doAfter() {
                var driveUrls = document.getElementById('drive-urls').value.trim().split('\n');
                console.log(driveUrls);
                
                if (!(driveUrls.length === 1 && driveUrls[0] === '')) {
                    var driveNames = [];
                    var driveSizes = [];
                    
                    for (var i = 0; i < driveUrls.length; i++) {
                        // remove end of url
                        var match1 = driveUrls[i].split(',')[0].match(/https?:\/\/docs\.google\.com\/document\/d\/[\w-_]{44}\//);
                        var match2 = driveUrls[i].split(',')[0].match(/[0-9a-zA-Z-_]{44}/);
                        
                        if (match1 === null && match2 === null) {
                            console.log(driveUrls[i]);
                            alert('Url has to be a Google docs or Google slides url!');
                            return;
                        }
                        
                        if (match1 !== null) {
                            driveNames.push(driveUrls[i].split(',')[1]);
                            driveUrls[i] = match1[0] + 'mobilebasic';
                            driveSizes.push('?');
                        } else if (match2 !== null) {
                            driveNames.push(driveUrls[i].split(',')[1]);
                            driveUrls[i] = 'https://docs.google.com/presentation/embed?id=' + match2[0] + '&start=false&loop=false';
                            driveSizes.push('?');
                        }
                    }
                    
                    downloadURLs.push.apply(downloadURLs, driveUrls);
                    downloadNames.push.apply(downloadNames, driveNames);
                    downloadSizes.push.apply(downloadSizes, driveSizes);
                }
                
                
                if (downloadURLs.length < 1) {
                    alert('No files or urls to upload!');
                    return;
                }
                
                ref.child('resourceUrls').push({
                    event: document.getElementById('event-name').value,
                    names: downloadNames.toString(),
                    urls: downloadURLs.toString(),
                    sizes: downloadSizes.toString()
                });
                
                alert('File(s) uploaded successfully!');
                // reload page
                Singulr.loadPage('resources.html');
            }
        };
        
        
        function formatBytes(bytes, decimals) {
            if (bytes == 0) return '0 Byte';
            var k = 1000;
            var dm = decimals + 1 || 3;
            var sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB', 'PB', 'EB', 'ZB', 'YB'];
            var i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(dm)) + ' ' + sizes[i];
        }
        
        
        function uploadFile(file, i, callback) {
            var uploadTask = storageRef.child('resources/' + file.name).put(file);
            window.ut = uploadTask;

            uploadTask.on('state_changed', (function(i) {
                return function(snapshot) {
                    var progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
                    updateProgressBarAndPercent(document.getElementById('up' + i).childNodes[1], document.getElementById('up' + i).childNodes[2], progress);
                };
            })(i), (function(i) {
                return function(error) {
                    // Handle unsuccessful uploads
                    if (error.code === 'storage/canceled') {
                        return;
                    }
                    console.error(error.message);
                    alert('An error occured. Files were not uploaded.');
                };
            })(i), (function(i) {
                return function() {
                    // Handle successful uploads on complete
                    callback(uploadTask.snapshot.downloadURL, i);
                };
            })(i));
            
            
            
            var uploadProgress = document.getElementById('upload-progress');
            
            
            // create progress bar
            var uploadContainer = document.createElement('div');
            uploadContainer.setAttribute('class', 'upload-container');
            uploadContainer.setAttribute('id', 'up' + i);
            
            var uploadName = document.createElement('div');
            uploadName.setAttribute('class', 'upload-name');
            uploadName.innerHTML = file.name;
            uploadContainer.appendChild(uploadName);
            
            var uploadPercent = document.createElement('div');
            uploadPercent.setAttribute('class', 'upload-percent');
            uploadContainer.appendChild(uploadPercent);
            
            var uploadProgressBar = document.createElement('div');
            uploadProgressBar.setAttribute('class', 'upload-progress-bar');
            updateProgressBarAndPercent(uploadPercent, uploadProgressBar, 0);
            uploadContainer.appendChild(uploadProgressBar);
            
            var uploadCancel = document.createElement('div');
            uploadCancel.setAttribute('class', 'upload-cancel');
            uploadCancel.innerHTML = 'X';
            uploadCancel.addEventListener('click', (function(uploadTask, i) {
                return function() {
                    // user canceled download
                    uploadTask.cancel();
                    
                    // slide up the element then remove for smoother removal
                    $('#up' + i).slideUp(function() {
                        $(this).remove();
                    });
                };
            })(uploadTask, i));
            uploadContainer.appendChild(uploadCancel);
            
            
            uploadProgress.appendChild(uploadContainer);
        }
        
        
        
        function updateProgressBarAndPercent(percent, progressBar, progress) {
            // rounds progress to 2 decimal places and makes sure 1.50 turns into 1.5
            progress = +progress.toFixed(2);
            progressBar.style.width = progress + '%';
            percent.innerHTML = progress + '%';
        }
        
        
        
        */
        function openModal(e, url, name) {
            var title;
            if (name === undefined && e !== undefined) {
                title = (e.tagName === 'A' ? title = e.innerHTML : e.attributes.alt.nodeValue);
            }
            else {
                title = name;
            }

            $('#myModalLabel').html(title);
            $('#ifr').attr('src', url);
            $('#mdlk').attr('href', url.replace("/mobilebasic", "/"));
            $('#myModal').modal('show');
        }

        function requestFullScreen() {
            var el = document.getElementById("ifr");
            // Supports most browsers and their versions.
            var requestMethod = el.requestFullScreen || el.webkitRequestFullScreen || el.mozRequestFullScreen || el.msRequestFullScreen;

            if (requestMethod) {
                requestMethod.call(el);
                // Older IE.
            }
            else if (typeof window.ActiveXObject !== "undefined") {
                var wscript = new ActiveXObject("WScript.Shell");

                if (wscript !== null) {
                    wscript.SendKeys("{F11}");
                }
            }
        }
    </script>

</body>

</html>
