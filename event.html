<!DOCTYPE html>
<html>

<head>

    <script class="singulr-ignore" src="js/singulr-page.js"></script>

    <title>Event - Troop 485</title>
    <style>
        .hidden {
            display: none;
        }
        
        .print {
            display: none;
        }
        
        @media print {
            * {
                visibility: hidden;
            }
            #main {
                display: none;
            }
            .print,
            .print * {
                visibility: visible;
                display: block;
            }
        }
        
        #export-description {
            resize: vertical;
            /* user can resize vertically, but width is fixed */
        }
    </style>
</head>

<body>

    <div class="alert alert-info alert-dismissible alert-visible hidden" role="alert" id="edit-alert-box">
        <button type="button" class="close" data-dismiss="alert" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <span id="edit-alert">You can <a id="edit" class="alert-link">edit this page</a>.<a id="export" class="alert-link">Export or Send this page
        (slack, googlegroups, email, download).</a> <a id="share" class="hidden alert-link">Allow others to edit this page.</a><a id="delete" class="hidden alert-link"> Delete this page.</a></span>
    </div>

    </div>
    </p>
    <div class="container">
        <div class="print col-lg-12" id="print">
            <h2 class="text-center event-title">Loading...</h2>
            <hr>
            <p class="event-description">Loading...</p>
            <br>
            <br>
            <br>
            <hr>
            <p>Read more at the event page:<span id="print-url"></span></p>
        </div>
        <div class="row" id="main">
            <div class="box">
                <div class="col-lg-12">
                    <hr>
                    <h2 class="intro-text text-center editable" id="event-title">Loading...</h2>
                    <hr>
                </div>
                <div class="col-md-12" id="event-description-box">
                    <div class="editable" id="event-description">Loading...</div>

                </div>

                <div class="clearfix"></div>
            </div>
        </div>

        <script src="https://static.getclicky.com/js"></script>
        <script>try {clicky.init(100869133)}catch (e) {}</script>
        <noscript><p><img alt="Clicky" width="1" height="1" src="https://in.getclicky.com/100869133ns.gif"></p></noscript>

    </div>
    <!-- /.container -->

    <script src='https://cdn.tinymce.com/4/tinymce.min.js'></script>
    <script src="js/jspdf.min.js"></script>
    <script src="js/printthis.js"></script>
    <script>
        /* global firebase $ getQuery tinymce btoa auth Singulr jsPDF*/

        $(".at").html("@");
        $(".event-page-url").html("https://t485.org/event.html?event=" + getQuery("event"));
        if (getQuery("event") === null || getQuery("event") === "") {
            window.location.href = "/resources.html";
        }
        firebase.database().ref('/events/' + encodeURIComponent(getQuery("event"))/*URL is url safe anyways, this is to trigger the data = null 404
        when the event contains non URL safe charcters*/).once('value').then(function(snapshot) {
            var data = snapshot.val();
            if (data === null || data === 0) {
                $("#event-title").html("Error 404: Event Not Found");
                $("#event-description").html("The specified event <b>" + getQuery("event") + "</b> was not found. If you typed in a link to view this page, try going to the <a href='resources.html'>resources page</a> and clicking a link from there.");
                $(".event-title").html("Error 404: Event Not Found");
                $(".event-description").html("The specified event <b>" + getQuery("event") + "</b> was not found. If you typed in a link to view this page, try going to the <a href='resources.html'>resources page</a> and clicking a link from there.");


            }
            else {
                $("#event-title").html(data.title);
                $("#event-description").html(data.description);
                $(".event-title").html(data.title);
                $(".event-description").html(data.description);
                $("#print-url").html("<a href='" + "https://t485.org/event.html?event=" + getQuery("event") + "'>" + "https://t485.org/event.html?event=" + getQuery("event") + "</a>");
                main();
            }

        });

       function main() {
            if (getQuery("password") !== null) {
            firebase.database().ref('/events/' + getQuery("event") + "/editlinks/").on('child_added', function(snapshot) {


                if (snapshot.val() === encodeURIComponent(getQuery("token"))) {

                    $("#edit-alert-box").removeClass("hidden");
                    $("#edit").click(function() {
                        $("#edit-alert").html("Click on some text to edit it. After you edit some text, click save changes on the toolbar that pops up. This will save the text only on the paragraph you selected. Or <a id='view' class='alert-link'>View this page</a>.");
                        $("#view").click(function() {
                            reloadPage();
                        });
                        tinymce.init({
                            selector: "#event-title", //'h2.editable',
                            inline: true,
                            plugins: [
                                "textcolor colorpicker link"
                            ],
                            toolbar: "undo redo | forecolor backcolor | link | save",
                            menubar: false,
                            setup: function(editor) {
                                editor.addButton("save", {
                                    text: "Save Changes",
                                    icon: false,
                                    onclick: function() {
                                        console.log(editor.getContent());
                                        console.log(editor.id);
                                        firebase.database().ref("/events/" + getQuery("event") + "/" + editor.id.replace("event-", "") + "/").set(editor.getContent());
                                    }
                                });
                            }
                        });

                        tinymce.init({
                            selector: "#event-description", //'div.editable',
                            inline: true,
                            plugins: [
                                "advlist autolink lists link image charmap print preview",
                                "searchreplace visualblocks fullscreen textcolor colorpicker",
                                "insertdatetime media table contextmenu paste imagetools"
                            ],
                            link_assume_external_targets: true,
                            removed_menuitems: "newdocument",
                            setup: function(editor) {
                                editor.addButton("save", {
                                    text: "Save Changes",
                                    icon: false,
                                    onclick: function() {
                                        console.log(editor.getContent());
                                        console.log(editor.id);
                                        firebase.database().ref("/events/" + getQuery("event") + "/" + editor.id.replace("event-", "") + "/").set(editor.getContent());
                                    }
                                });
                            },
                            toolbar: "insertfile undo redo | styleselect | bold italic | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | save"
                        });

                    });

                }
            });
        }

        function generateRandomStr() {
            var text = "";
            var possible = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_-+={}[]|?/>.<,";

            for (var i = 0; i < 40; i++)
                text += possible.charAt(Math.floor(Math.random() * possible.length));

            return encodeURIComponent(btoa(text));
        }


        firebase.database().ref('/events/' + getQuery("event")).once('value').then(function(snapshot) {
            var data = snapshot.val();

            $("#event-title").html(data.title);
            $("#event-description").html(data.description);

        });

        function deleteLink(id) {
            firebase.database().ref('/events/' + getQuery("event") + "/editlinks/" + id).set(null);
            $("#share-modal").modal("hide");


        }
        auth(function(user) {
            firebase.database().ref('/events/' + getQuery("event")).once('value').then(function(snapshot) {
                var uid = snapshot.val().owner;
                if (uid === user.uid) {

                    $("#edit-alert-box").removeClass("hidden");
                    $("#share").removeClass("hidden");
                    $("#delete").removeClass("hidden");


                    

                    $("#delete").click(function() {
                        $("#confirm-delete").modal("show");
                        $("#confirm-enter-name").keyup(function() {
                            if (($("#confirm-enter-name").val().toLowerCase() === snapshot.val().title.toLowerCase()) && getQuery("event") !== null) {
                                $("#confirm-delete-button").removeClass("disabled");
                                $("#confirm-delete-button").on("click", function() {
                                    firebase.database().ref('/events/' + getQuery("event")).set(null);
                                    $("#confirm-delete").modal("hide");
                                    Singulr.loadPage("resources.html");
                                });
                            }
                            else {
                                $("#confirm-delete-button").addClass("disabled");
                                $("#confirm-delete-button").off("click");
                            }
                        });

                    });
                    $("#share").click(function() {

                        $("#share-modal").modal("show");
                        firebase.database().ref('/events/' + getQuery("event") + "/editlinks/").on("child_added", function(data) {

                            console.log(data.val());
                            console.log(data.key);
                            $("#links").append("<li><b>https://t485.org/event.html?event=" + getQuery("event") + "&token=" + data.val() + "</b> (<a onclick='deleteLink(\"" + data.val() + "\")'>Remove This Link</a>)</li><hr>");
                        });


                    });


                    $("#new-access-link").click(function() {
                        var id = generateRandomStr();
                        firebase.database().ref('/events/' + getQuery("event") + "/editlinks/" + id).set(id);

                    });
                    $("#edit").click(function() {
                        $("#edit-alert").html("Click on some text to edit it. After you edit some text, click save changes on the toolbar that pops up. This will save the text only on the paragraph you selected. Or <a id='view' class='alert-link'>View this page</a>.");
                        $("#view").click(function() {
                            reloadPage();
                        });
                        tinymce.init({
                            selector: "#event-title", //'h2.editable',
                            inline: true,
                            plugins: [
                                "textcolor colorpicker link"
                            ],
                            toolbar: "undo redo | forecolor backcolor | link | save",
                            menubar: false,
                            setup: function(editor) {
                                editor.addButton("save", {
                                    text: "Save Changes",
                                    icon: false,
                                    onclick: function() {
                                        console.log(editor.getContent());
                                        console.log(editor.id);
                                        firebase.database().ref("/events/" + getQuery("event") + "/" + editor.id.replace("event-", "") + "/").set(editor.getContent());
                                    }
                                });
                            }
                        });

                        tinymce.init({
                            selector: "#event-description", //'div.editable',
                            inline: true,
                            plugins: [
                                "advlist autolink lists link image charmap print preview",
                                "searchreplace visualblocks fullscreen textcolor colorpicker",
                                "insertdatetime media table contextmenu paste imagetools"
                            ],
                            link_assume_external_targets: true,
                            removed_menuitems: "newdocument",
                            setup: function(editor) {
                                editor.addButton("save", {
                                    text: "Save Changes",
                                    icon: false,
                                    onclick: function() {
                                        console.log(editor.getContent());
                                        console.log(editor.id);
                                        firebase.database().ref("/events/" + getQuery("event") + "/" + editor.id.replace("event-", "") + "/").set(editor.getContent());
                                    }
                                });
                            },
                            toolbar: "insertfile undo redo | styleselect | bold italic | forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | save"
                        });


                    });
                }

            });

            function getFirebaseDataThen(callback, requireDescription) {
                firebase.database().ref('/events/' + getQuery("event")).once('value').then(function(snapshot) {
                    var data = snapshot.val();

                    if (data !== null) {
                        if ($("#export-description").val().replace(" ", "") === "" && requireDescription !== false) {
                            alert("You must write a description. (You can just copy/paste from the event page. Note links and formatting will be removed)");
                        }
                        else {
                            var text = $("#export-description").val() + "\n --- \n Read more at the event page: https://t485.org/event.html?event=" + getQuery("event");
                            callback(data.title, text, "https://t485.org/event.html?event=" + getQuery("event"), data.description);
                        }

                    }
                    else {
                        alert("Unknown error occured. Please try again or notify the webmaster.", "https://t485.org/event.html?event=" + getQuery("event"));
                    }
                });
            }
            $("#export-slack").click(function() {

                getFirebaseDataThen(function(title, text, url) {
                    $.post("https://hooks.slack.com/services/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", "payload=" + JSON.stringify({
                            "text": "Event Page shared:",
                            "attachments": [{
                                "fallback": "A event page was shared: <" + title + "|https://t485.org/event.html?event=" + url + ">.",
                                "title": title,
                                "title_link": url,
                                "text": text,
                                "footer": "This is a T485 event page automated message"
                            }]
                        }),
                        function(data) {
                            window.location.href = url;
                        }
                    );
                    $("#export-slack").html("Exported to slack - Export again");
                });

            });
            $("#export-gmail").click(function() {
                getFirebaseDataThen(function(title, text, url) {
                    window.location.href = "https://mail.google.com/mail/?view=cm&fs=1&tf=1&su=" + encodeURIComponent(title) + "&body=" + encodeURIComponent(text);
                    $("export-modal").modal("hide");
                });
            });
            $("#export-yahoo").click(function() {
                getFirebaseDataThen(function(title, text, url) {
                    window.location.href = "http://compose.mail.yahoo.com/?subject=" + encodeURIComponent(title) + "&body=" + encodeURIComponent(text);
                    $("export-modal").modal("hide");
                });
            });
            $("#export-hotmail").click(function() {
                getFirebaseDataThen(function(title, text, url) {
                    window.location.href = "https://dub130.mail.live.com/default.aspx?rru=compose&subject=" + encodeURIComponent(title) + "&body=" + encodeURIComponent(text) + "#page=Compose";
                    $("export-modal").modal("hide");
                });
            });
            $("#export-aol").click(function() {
                getFirebaseDataThen(function(title, text, url) {
                    window.location.href = "http://webmail.aol.com/Mail/ComposeMessage.aspx?subject=" + encodeURIComponent(title) + "&body=" + encodeURIComponent(text);
                    $("export-modal").modal("hide");

                });
            });
            $("#export-email").click(function() {
                getFirebaseDataThen(function(title, text, url) {
                    window.location.href = "mailto:?Subject=" + encodeURIComponent(title) + "&Body=" + encodeURIComponent(text);
                    $("export-modal").modal("hide");
                });
            });
            $("#export-pdf").click(function() {
                getFirebaseDataThen(function(title, text, url) {
                    var doc = new jsPDF();
                    var specialElementHandlers = {
                        '#editor': function(element, renderer) {
                            return true;
                        }
                    };


                    doc.fromHTML($('#print').html(), 15, 15, {
                        'width': 170,
                        'elementHandlers': specialElementHandlers
                    });
                    doc.save(title + '.pdf');

                    $("export-modal").modal("hide");
                });

            });
            getFirebaseDataThen(function(title, text, url, realtext) {
                $("#export-html").attr("href", "data:text/html,<html><head></head><body><h1>" + title + "</h1><div>" + realtext + "</div><br><br><br><hr><p>Read more at the <a href='" + url + "'>event page</a>.</p></body></html>");
                $("#export-html").attr("download", title + ".html");
            }, false);



            $("#export-print").click(function() {
                console.log(1);
                getFirebaseDataThen(function(title, text, url) {
                    console.log(2);
                    $("#print").printThis();

                }, false);
            });

            $("#export").click(function() {
                $("#export-modal").modal("show");
            });

        }, function() {
            Singulr.loadPage('login.html?redir=event.html' + encodeURIComponent(window.location.search));
        });
       }

        function reloadPage() {
            Singulr.loadPage(window.location.pathname + window.location.search + window.location.hash);
        }
    </script>
    <!-- Modal -->
    <div class="modal fade" id="share-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Allow other users to edit this page.</h4>
                </div>
                <div class="modal-body col-lg-12">
                    <p>Modify access links: Here you can create new edit links and also delete links. Only you and not other editors can change links.</p>
                    <ul id="links">

                    </ul>
                    <button class="btn btn-success" id="new-access-link">New Access Link</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>

                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="export-modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">Export or Send this page</h4>
                </div>
                <div class="modal-body col-lg-12">

                    <h3>Choose a export method:</h3>
                    <p>
                        The url of your event page is: <b class="event-page-url"></b>
                        <br> To export to the T485 google group, choose any email export and enter send it to the T485 google groups. <b>t485<span class="at"> [a t ]] </span>googlegroups.com</b> as the recipient.
                        <hr>
                        <b>Enter a description of the event(Required for all options except for download and print. Ignored for download and print. This will be exported):</b>
                        <textarea id="export-description" class="form-control"></textarea>
                        <a id="export-email">Email - Mail App/Defualt mail handler</a><br>
                        <a id="export-gmail">Email - Gmail</a><br>
                        <a id="export-yahoo">Email - Yahoo</a><br>
                        <a id="export-hotmail">Email - Hotmail</a><br>
                        <a id="export-aol">Email - AOL</a><br>
                        <a id="export-slack">Slack</a><br>

                        <a id="export-pdf">Download - PDF</a><br>
                        <a id="export-html">Download - Offline Webpage(HTML)</a><br>
                        <a id="export-print">Print</a><br>

                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>

                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="confirm-delete" tabindex="-1" role="dialog" onclick="window.location.hash = '';" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="modal-title">Please Confirm</h4>
                </div>
                <div class="modal-body" id="modal-body">
                    <h6>Dangrous Things will happen if you don't pay attention!</h6>
                    <p class="test-danger">You are about to delete a event page. In order to proceed, please type in the name of the event page you are trying to delete.</p>
                    <input class="form-control" type="text" id="confirm-enter-name">
                    <button class="form-control btn btn-danger disabled" id="confirm-delete-button">Delete</button>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" onclick="window.location.hash = '';" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    </div>

</body>
